<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Nexus</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: #f0f2f5;
            color: #1a1a1a;
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
        }

        .card {
            background: #fff;
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-3px);
        }

        .post-form textarea {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            background: #fafafa;
        }

        .post {
            margin-bottom: 2rem;
        }

        .timestamp {
            font-size: 0.9rem;
            color: #666;
        }

        .comment-section {
            background: #f8f9fa;
            border-radius: 0 0 15px 15px;
            padding: 1.5rem;
        }

        .popup {
            background: rgba(0, 0, 0, 0.7);
        }

        .btn-primary {
            background: #007bff;
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #0056b3;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
        }

        .btn-action {
            background: none;
            border: none;
            color: #555;
            padding: 8px 12px;
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .btn-action:hover {
            background: #e9ecef;
            color: #007bff;
        }

        .reaction-count {
            font-size: 0.95rem;
            margin-left: 6px;
        }

        .active-like {
            color: #28a745 !important;
            background: #e6ffe6 !important;
        }

        .active-dislike {
            color: #dc3545 !important;
            background: #ffe6e6 !important;
        }

        .header {
            background: #fff;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div id="namePopup" class="popup">
        <div class="popup-content card p-4">
            <h3 class="text-center mb-4" style="color: #007bff;">Join Community Nexus</h3>
            <input type="text" id="userNameInput" class="form-control mb-3" placeholder="Enter your name" maxlength="20">
            <button class="btn btn-primary w-100" onclick="joinCommunity()">Join Now</button>
        </div>
    </div>

    <div id="community" class="container mt-4 d-none">
        <div class="header">
            <h1 class="text-center m-0" style="color: #1a1a1a;">Community Nexus</h1>
        </div>
        <div class="post-form card p-4 mb-5">
            <textarea id="postInput" class="form-control mb-3" placeholder="What's on your mind?" rows="3" maxlength="500"></textarea>
            <button class="btn btn-primary" onclick="submitPost()">Post</button>
        </div>
        <div id="postsContainer"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import {
            getDatabase,
            ref,
            set,
            push,
            onValue,
            update,
            get,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBzvajFC_47PW9Z0EHRZoT-hrmqnkL0KNI",
            authDomain: "mehedi-catting.firebaseapp.com",
            databaseURL: "https://mehedi-catting-default-rtdb.firebaseio.com",
            projectId: "mehedi-catting",
            storageBucket: "mehedi-catting.firebasestorage.app",
            messagingSenderId: "3798147418",
            appId: "1:3798147418:web:ea9a059c8db3c147319363",
            measurementId: "G-CFGBXWVC3V"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let userName = localStorage.getItem("userName");

        initializeAppState();

        function initializeAppState() {
            if (!userName) {
                document.getElementById("namePopup").style.display = "flex";
            } else {
                showCommunity();
                fetchPosts();
            }
        }

        window.joinCommunity = async () => {
            const nameInput = document.getElementById("userNameInput").value.trim();
            if (!validateInput(nameInput, 1, 20)) {
                showError("Please enter a name (max 20 characters)");
                return;
            }

            userName = sanitizeInput(nameInput);
            localStorage.setItem("userName", userName);
            await set(ref(db, `users/${userName}`), {
                name: userName,
                joinedAt: serverTimestamp()
            });
            hidePopup();
            showCommunity();
            fetchPosts();
        };

        window.submitPost = async () => {
            const postContent = document.getElementById("postInput").value.trim();
            if (!validateInput(postContent, 1, 500)) {
                showError("Post must be 1-500 characters");
                return;
            }

            const postsRef = ref(db, "posts");
            const newPostRef = push(postsRef);
            await set(newPostRef, {
                content: sanitizeInput(postContent),
                author: userName,
                timestamp: serverTimestamp(),
                likes: 0,
                dislikes: 0,
                reactions: {}
            });
            document.getElementById("postInput").value = "";
        };

        function fetchPosts() {
            onValue(ref(db, "posts"), (snapshot) => {
                const postsContainer = document.getElementById("postsContainer");
                postsContainer.innerHTML = "";
                const posts = snapshot.val();

                if (posts) {
                    Object.entries(posts).reverse().forEach(([postId, post]) => {
                        renderPost(postId, post);
                    });
                } else {
                    postsContainer.innerHTML = '<p class="text-center text-muted">No posts yet. Start the conversation!</p>';
                }
            });
        }

        function renderPost(postId, post) {
            const timestamp = post.timestamp ? new Date(post.timestamp).toLocaleString() : "Just now";
            const userReaction = post.reactions?.[userName];
            const postsContainer = document.getElementById("postsContainer");
            const postElement = document.createElement("div");
            postElement.className = "post card p-4";
            postElement.innerHTML = `
                <div class="d-flex justify-content-between mb-3">
                    <strong style="color: #007bff;">${post.author || "Anonymous"}</strong>
                    <span class="timestamp">${timestamp}</span>
                </div>
                <p class="mb-4" style="font-size: 1.1rem; line-height: 1.6;">${post.content}</p>
                <div class="d-flex gap-3">
                    <button class="btn-action ${userReaction === 'like' ? 'active-like' : ''}" 
                        onclick="reactToPost('${postId}', 'like', ${post.likes || 0}, ${post.dislikes || 0})">
                        <i class="fas fa-thumbs-up"></i>
                        <span class="reaction-count">${post.likes || 0}</span>
                    </button>
                    <button class="btn-action ${userReaction === 'dislike' ? 'active-dislike' : ''}" 
                        onclick="reactToPost('${postId}', 'dislike', ${post.likes || 0}, ${post.dislikes || 0})">
                        <i class="fas fa-thumbs-down"></i>
                        <span class="reaction-count">${post.dislikes || 0}</span>
                    </button>
                    <button class="btn-action" onclick="toggleComments('${postId}')">
                        <i class="fas fa-comment"></i> Comment
                    </button>
                    <button class="btn-action" onclick="sharePost('${postId}')">
                        <i class="fas fa-share"></i> Share
                    </button>
                </div>
                <div id="comments-${postId}" class="comment-section mt-3 d-none">
                    <textarea class="form-control mb-3" placeholder="Add your comment..." rows="2" maxlength="200" id="commentInput-${postId}"></textarea>
                    <button class="btn btn-sm btn-primary" onclick="submitComment('${postId}')">Comment</button>
                    <div id="commentList-${postId}" class="mt-3"></div>
                </div>
            `;
            postsContainer.appendChild(postElement);
            fetchComments(postId);
        }

        window.reactToPost = async (postId, reactionType, currentLikes, currentDislikes) => {
            try {
                const postRef = ref(db, `posts/${postId}`);
                const snapshot = await get(postRef);
                const post = snapshot.val();
                const userReaction = post.reactions?.[userName];

                if (userReaction === reactionType) return;

                let updates = { reactions: post.reactions || {} };
                let newLikes = currentLikes;
                let newDislikes = currentDislikes;

                if (userReaction) {
                    if (userReaction === 'like' && newLikes > 0) newLikes--;
                    if (userReaction === 'dislike' && newDislikes > 0) newDislikes--;
                }

                updates.reactions[userName] = reactionType;
                if (reactionType === 'like') newLikes++;
                if (reactionType === 'dislike') newDislikes++;

                updates.likes = newLikes;
                updates.dislikes = newDislikes;

                await update(postRef, updates);
            } catch (error) {
                handleFirebaseError(error, "Failed to react to post");
            }
        };

        window.toggleComments = (postId) => {
            const commentSection = document.getElementById(`comments-${postId}`);
            commentSection.classList.toggle("d-none");
        };

        window.submitComment = async (postId) => {
            const commentInput = document.getElementById(`commentInput-${postId}`).value.trim();
            if (!validateInput(commentInput, 1, 200)) {
                showError("Comment must be 1-200 characters");
                return;
            }

            await push(ref(db, `comments/${postId}`), {
                content: sanitizeInput(commentInput),
                author: userName,
                timestamp: serverTimestamp()
            });
            document.getElementById(`commentInput-${postId}`).value = "";
        };

        function fetchComments(postId) {
            onValue(ref(db, `comments/${postId}`), (snapshot) => {
                const commentList = document.getElementById(`commentList-${postId}`);
                commentList.innerHTML = "";
                const comments = snapshot.val();

                if (comments) {
                    Object.values(comments).forEach(comment => {
                        const timestamp = comment.timestamp ? new Date(comment.timestamp).toLocaleString() : "Just now";
                        commentList.innerHTML += `
                            <div class="mb-3">
                                <strong style="color: #007bff;">${comment.author || "Anonymous"}</strong>: ${comment.content}
                                <small class="timestamp d-block">${timestamp}</small>
                            </div>
                        `;
                    });
                }
            });
        }

        window.sharePost = async (postId) => {
            const snapshot = await get(ref(db, `posts/${postId}`));
            const post = snapshot.val();
            const shareUrl = `${window.location.href}#${postId}`;
            if (navigator.share) {
                await navigator.share({
                    title: "Community Nexus Post",
                    text: post.content,
                    url: shareUrl
                });
            } else {
                prompt("Share this link:", shareUrl);
            }
        };

        function validateInput(input, min, max) {
            return input && input.length >= min && input.length <= max;
        }

        function sanitizeInput(input) {
            const div = document.createElement("div");
            div.textContent = input;
            return div.innerHTML;
        }

        function showError(message) {
            alert(message);
        }

        function handleFirebaseError(error, context) {
            console.error(`${context}:`, error);
            showError(`${context}: ${error.message}`);
        }

        function hidePopup() {
            document.getElementById("namePopup").style.display = "none";
        }

        function showCommunity() {
            document.getElementById("community").classList.remove("d-none");
        }
    </script>
</body>
</html>
