<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Social Community App - Light Theme</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #f5f5f5;
            color: #333;
            font-family: 'Poppins', sans-serif;
            min-height: 100vh;
        }
        /* Light Theme */
        .glow {
            text-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
        }
        .border-glow {
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.2);
        }
        .navbar {
            background: #fff;
            padding: 15px 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .navbar h5 {
            font-family: 'Roboto', sans-serif;
            font-weight: 700;
            font-size: 1.8rem;
            color: #007bff;
        }
        .nav-tabs {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
        }
        .nav-tabs .nav-link {
            color: #555;
            background: #e9ecef;
            border-radius: 20px;
            padding: 8px 20px;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
        }
        .nav-tabs .nav-link:hover {
            background: #d1e7ff;
            color: #007bff;
        }
        .nav-tabs .nav-link.active {
            background: #007bff;
            color: #fff;
        }
        .profile-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #007bff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #fff;
            cursor: pointer;
            transition: transform 0.5s ease;
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.2);
        }
        .profile-icon:hover { transform: rotate(360deg); }
        .search-bar {
            position: relative;
            width: 100%;
            max-width: 350px;
            margin: 15px auto;
        }
        .search-bar input {
            background: #fff;
            border: 1px solid #007bff;
            border-radius: 25px;
            padding: 10px 45px 10px 20px;
            color: #333;
            font-size: 1rem;
            width: 100%;
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.1);
        }
        .search-bar input:focus {
            outline: none;
            border-color: #0056b3;
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.3);
        }
        .search-bar i {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #007bff;
            font-size: 1.2rem;
        }
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: #fff;
            border-radius: 15px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }
        .search-result-item {
            padding: 10px 15px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            color: #333;
            font-size: 1rem;
            transition: background 0.3s ease;
        }
        .search-result-item:hover {
            background: #d1e7ff;
        }
        .search-result-item span {
            color: #007bff;
            font-weight: 500;
        }
        .post {
            background: #fff;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 20px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .user-initial {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-right: 15px;
            background: #007bff;
            color: #fff;
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.2);
        }
        .username {
            font-size: 1.2rem;
            font-weight: 600;
            color: #007bff;
            text-decoration: none;
            cursor: pointer;
        }
        .time-ago {
            display: block;
            color: #666;
            font-size: 0.9rem;
        }
        .post-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }
        .post-content {
            font-size: 1.1rem;
            line-height: 1.6;
        }
        .post-content a {
            color: #007bff;
            text-decoration: underline;
            word-break: break-all;
        }
        .post-type {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #e9ecef;
            color: #007bff;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
        }
        .post-actions {
            display: flex;
            gap: 30px;
            margin-top: 15px;
            position: relative;
        }
        .post-actions i {
            color: #666;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .post-actions i:hover {
            color: #007bff;
        }
        .post-actions .active-reaction {
            color: #007bff;
        }
        .reaction-menu {
            display: none;
            position: absolute;
            background: #fff;
            border-radius: 15px;
            padding: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            top: -50px;
            left: 0;
            gap: 10px;
            white-space: nowrap;
        }
        .reaction-menu span {
            cursor: pointer;
            font-size: 1.2rem;
            margin: 0 5px;
            transition: transform 0.3s ease;
        }
        .reaction-menu span:hover {
            transform: scale(1.3);
        }
        .reaction-icons {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .reaction-icons span {
            font-size: 1.2rem;
        }
        .reaction-count {
            cursor: pointer;
            color: #007bff;
        }
        .comment-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
            display: none;
        }
        .comment-section.active { display: block; }
        .comment-input {
            background: #f5f5f5;
            border: 1px solid #007bff;
            border-radius: 15px;
            padding: 10px 15px;
            color: #333;
            width: 100%;
            font-size: 1rem;
        }
        .comment-input:focus {
            outline: none;
            border-color: #0056b3;
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.2);
        }
        .comment {
            background: #f5f5f5;
            padding: 10px 15px;
            border-radius: 15px;
            margin-top: 10px;
            font-size: 0.95rem;
        }
        .comment .comment-user {
            color: #007bff;
            font-weight: 500;
        }
        .comment .comment-time {
            display: block;
            color: #666;
            font-size: 0.8rem;
        }
        .post-btn {
            background: #007bff;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            color: #fff;
            font-weight: 600;
            font-size: 1rem;
            position: fixed;
            bottom: 25px;
            right: 25px;
            z-index: 1000;
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.2);
            transition: all 0.3s ease;
        }
        .post-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(0, 123, 255, 0.3);
        }
        .modal-content {
            background: #fff;
            border: 1px solid #007bff;
            border-radius: 20px;
            color: #333;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        .modal-header, .modal-footer {
            border-color: #e9ecef;
        }
        .modal-body input, .modal-body textarea, .modal-body select {
            background: #f5f5f5;
            border: 1px solid #007bff;
            color: #333;
            border-radius: 15px;
            padding: 10px 15px;
            font-size: 1rem;
        }
        .modal-body input:focus, .modal-body textarea:focus, .modal-body select:focus {
            outline: none;
            border-color: #0056b3;
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.2);
        }
        .modal-footer .btn-primary {
            background: #007bff;
            color: #fff;
            border: none;
        }
        .auth-btn {
            background: #007bff;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.2);
        }
        .auth-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.3);
        }
        .delete-btn, .report-btn {
            color: #dc3545;
            font-size: 1.2rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .delete-btn:hover, .report-btn:hover {
            color: #b02a37;
        }
        .share-options {
            display: none;
            position: absolute;
            background: #fff;
            border-radius: 15px;
            padding: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        .share-options a {
            display: block;
            color: #333;
            padding: 8px 15px;
            text-decoration: none;
            font-size: 1rem;
        }
        .share-options a:hover {
            background: #d1e7ff;
            color: #007bff;
        }
        .activity-item, .reaction-item, .report-item {
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.95rem;
        }
        /* Mobile Responsiveness */
        @media (max-width: 576px) {
            .navbar { padding: 10px 15px; }
            .navbar h5 { font-size: 1.5rem; }
            .nav-tabs .nav-link { padding: 6px 15px; font-size: 0.9rem; }
            .profile-icon { width: 35px; height: 35px; font-size: 1rem; }
            .auth-btn { padding: 8px 15px; font-size: 0.9rem; }
            .search-bar { max-width: 100%; margin: 10px 15px; }
            .search-bar input { padding: 8px 35px 8px 15px; font-size: 0.9rem; }
            .search-results { max-height: 250px; }
            .search-result-item { padding: 8px 12px; font-size: 0.9rem; }
            .post { padding: 15px; margin-bottom: 15px; }
            .user-initial { width: 40px; height: 40px; font-size: 1.2rem; margin-right: 10px; }
            .username { font-size: 1.1rem; }
            .time-ago { font-size: 0.8rem; }
            .post-title { font-size: 1.3rem; }
            .post-content { font-size: 1rem; }
            .post-type { font-size: 0.8rem; padding: 4px 10px; }
            .post-actions i { font-size: 1.1rem; }
            .reaction-menu { top: -45px; }
            .reaction-menu span { font-size: 1.1rem; }
            .comment-input { padding: 8px 12px; font-size: 0.9rem; }
            .comment { padding: 8px 12px; font-size: 0.85rem; }
            .post-btn { padding: 12px 25px; font-size: 0.9rem; bottom: 20px; right: 20px; }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="container-fluid d-flex justify-content-between align-items-center flex-wrap">
            <h5>Light Forum</h5>
            <div class="d-flex align-items-center gap-3">
                <button id="authButton" class="auth-btn">Sign In</button>
                <div id="profileIcon" class="profile-icon" style="display: none;" data-bs-toggle="modal" data-bs-target="#profileModal"></div>
            </div>
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search by title, content, user, or blood group...">
                <i class="bi bi-search"></i>
                <div class="search-results" id="searchResults"></div>
            </div>
            <ul class="nav nav-tabs mt-3">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-tab="all">All</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-tab="feed">Feed</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-tab="announcement">Announcement</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-tab="question">Question</a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Posts Container -->
    <div class="container mt-4" id="posts-container">
        <!-- Posts will be dynamically loaded here -->
    </div>

    <!-- Post Button -->
    <button id="postButton" class="post-btn" style="display: none;" data-bs-toggle="modal" data-bs-target="#postModal">Post</button>

    <!-- Post Modal -->
    <div class="modal fade" id="postModal" tabindex="-1" aria-labelledby="postModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title glow" id="postModalLabel">Create a Post</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="postTitle" class="form-control mb-3" placeholder="Post Title (Required)">
                    <select id="postType" class="form-select mb-3">
                        <option value="feed">Feed</option>
                        <option value="announcement">Announcement</option>
                        <option value="question">Question</option>
                    </select>
                    <textarea class="form-control" id="postContent" rows="5" placeholder="What's on your mind?"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitPost">Post</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal fade profile-modal" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title glow" id="profileModalLabel">Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="profilePhoto" class="rounded-circle mb-3 border-glow" style="width: 100px; height: 100px;" alt="Profile Photo">
                    <h5 id="profileName" class="glow"></h5>
                    <p id="profileEmail"></p>
                    <input type="text" id="profileUsername" class="form-control mb-3" placeholder="Update username">
                    <select id="profileBloodGroup" class="form-select mb-3" required>
                        <option value="" disabled selected>Select Blood Group (Required)</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                    </select>
                    <textarea id="profileNotebook" class="form-control mb-3" placeholder="Your Notebook" rows="3"></textarea>
                    <button class="btn btn-primary mb-3" id="saveProfile">Save Profile</button>
                    <button class="btn btn-primary mb-3" id="activityLogButton" data-bs-toggle="modal" data-bs-target="#activityModal">Activity Log</button>
                    <button class="btn btn-primary" id="signOutButton">Sign Out</button>
                    <div id="userPosts" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Public Profile Modal -->
    <div class="modal fade" id="publicProfileModal" tabindex="-1" aria-labelledby="publicProfileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title glow" id="publicProfileModalLabel">User Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="publicProfilePhoto" class="rounded-circle mb-3 border-glow" style="width: 100px; height: 100px;" alt="Profile Photo">
                    <h5 id="publicProfileName" class="glow"></h5>
                    <p id="publicProfileBloodGroup"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Log Modal -->
    <div class="modal fade" id="activityModal" tabindex="-1" aria-labelledby="activityModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title glow" id="activityModalLabel">Activity Log</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="activityLogContent">
                    <!-- Activity log will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title glow" id="notificationModalLabel">Notification</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="notificationMessage">
                    <!-- Notification message will be shown here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reaction Details Modal -->
    <div class="modal fade" id="reactionModal" tabindex="-1" aria-labelledby="reactionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title glow" id="reactionModalLabel">Reactions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="reactionDetails">
                    <!-- Reaction details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title glow" id="reportModalLabel">Report Post</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <textarea id="reportReason" class="form-control mb-3" placeholder="Reason for reporting..." rows="3"></textarea>
                    <div id="reportList"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitReport">Submit Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-analytics.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
        import { getDatabase, ref, push, onValue, set, remove, update, get } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDmJIWV2HSabLzgf7l6mJ4zdQaZVmckXdE",
            authDomain: "social-community-de517.firebaseapp.com",
            projectId: "social-community-de517",
            storageBucket: "social-community-de517.firebasestorage.app",
            messagingSenderId: "312580712536",
            appId: "1:312580712536:web:97c72be99dfec888aa022d",
            measurementId: "G-993HCEY87H"
        };

        // Initialize Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            getAnalytics(app);
            auth = getAuth(app);
            db = getDatabase(app);
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            showNotification("Failed to initialize Firebase. Check console for details.");
        }

        const provider = new GoogleAuthProvider();

        // DOM Elements
        const authButton = document.getElementById('authButton');
        const profileIcon = document.getElementById('profileIcon');
        const postButton = document.getElementById('postButton');
        const postsContainer = document.getElementById('posts-container');
        const submitPost = document.getElementById('submitPost');
        const postTitle = document.getElementById('postTitle');
        const postContent = document.getElementById('postContent');
        const postType = document.getElementById('postType');
        const profilePhoto = document.getElementById('profilePhoto');
        const profileName = document.getElementById('profileName');
        const profileEmail = document.getElementById('profileEmail');
        const profileUsername = document.getElementById('profileUsername');
        const profileBloodGroup = document.getElementById('profileBloodGroup');
        const profileNotebook = document.getElementById('profileNotebook');
        const saveProfile = document.getElementById('saveProfile');
        const signOutButton = document.getElementById('signOutButton');
        const activityLogButton = document.getElementById('activityLogButton');
        const activityLogContent = document.getElementById('activityLogContent');
        const userPosts = document.getElementById('userPosts');
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const notificationModal = new bootstrap.Modal(document.getElementById('notificationModal'));
        const notificationMessage = document.getElementById('notificationMessage');
        const reactionModal = new bootstrap.Modal(document.getElementById('reactionModal'));
        const reactionDetails = document.getElementById('reactionDetails');
        const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
        const reportReason = document.getElementById('reportReason');
        const reportList = document.getElementById('reportList');
        const submitReport = document.getElementById('submitReport');
        const publicProfileModal = new bootstrap.Modal(document.getElementById('publicProfileModal'));
        const publicProfilePhoto = document.getElementById('publicProfilePhoto');
        const publicProfileName = document.getElementById('publicProfileName');
        const publicProfileBloodGroup = document.getElementById('publicProfileBloodGroup');

        // Authentication State Listener
        let currentUser = null;
        let allPosts = [];
        let allUsers = [];
        let activityLog = [];
        let currentPostId = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                authButton.style.display = 'none';
                profileIcon.style.display = 'flex';
                postButton.style.display = 'block';
                profileIcon.textContent = user.displayName.charAt(0).toUpperCase();
                profilePhoto.src = user.photoURL || 'https://via.placeholder.com/100';
                profileName.textContent = user.displayName;
                profileEmail.textContent = user.email;
                console.log("User signed in:", user.uid);
                loadUserProfile(user.uid);
                loadAllUsers();
                checkSharedPost();
            } else {
                currentUser = null;
                authButton.style.display = 'block';
                profileIcon.style.display = 'none';
                postButton.style.display = 'none';
                postsContainer.innerHTML = '<p class="text-center">Please sign in to view posts.</p>';
                console.log("User signed out");
            }
        });

        // Sign In with Google
        authButton.addEventListener('click', () => {
            signInWithPopup(auth, provider)
                .then((result) => {
                    const user = result.user;
                    const userRef = ref(db, `users/${user.uid}`);
                    set(userRef, {
                        username: user.displayName,
                        email: user.email,
                        photoURL: user.photoURL || '',
                        bloodGroup: '',
                        notebook: '',
                        createdAt: Date.now(),
                        activityLog: []
                    }).then(() => {
                        console.log("User profile created in database");
                    }).catch((error) => {
                        console.error("Error creating user profile:", error);
                        showNotification("Error creating user profile: " + error.message);
                    });
                })
                .catch((error) => {
                    console.error("Sign-in error:", error);
                    showNotification("Error signing in: " + error.message);
                });
        });

        // Sign Out
        signOutButton.addEventListener('click', () => {
            signOut(auth)
                .then(() => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('profileModal'));
                    modal.hide();
                })
                .catch((error) => {
                    console.error("Sign-out error:", error);
                    showNotification("Error signing out: " + error.message);
                });
        });

        // Load User Profile
        function loadUserProfile(userId) {
            const userRef = ref(db, `users/${userId}`);
            onValue(userRef, (snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    profileUsername.value = userData.username || currentUser.displayName;
                    profileBloodGroup.value = userData.bloodGroup || '';
                    profileNotebook.value = userData.notebook || '';
                    activityLog = userData.activityLog || [];
                    loadUserPosts(userId);
                    console.log("User profile loaded:", userData);
                } else {
                    console.warn("No user data found for userId:", userId);
                }
            }, (error) => {
                console.error("Error loading user profile:", error);
                showNotification("Error loading user profile: " + error.message);
            });
        }

        // Load All Users for Search
        function loadAllUsers() {
            const usersRef = ref(db, 'users');
            onValue(usersRef, (snapshot) => {
                allUsers = [];
                snapshot.forEach((childSnapshot) => {
                    const user = childSnapshot.val();
                    user.id = childSnapshot.key;
                    allUsers.push(user);
                });
                console.log("All users loaded:", allUsers.length);
            }, { onlyOnce: true }, (error) => {
                console.error("Error loading users:", error);
            });
        }

        // Load User's Own Posts in Profile
        function loadUserPosts(userId) {
            userPosts.innerHTML = '<h6>Your Posts</h6>';
            const userPostsList = allPosts.filter(post => post.userId === userId);
            if (userPostsList.length === 0) {
                userPosts.innerHTML += '<p class="text-center">No posts yet.</p>';
            } else {
                userPostsList.forEach(post => {
                    const postElement = document.createElement('div');
                    postElement.classList.add('post', 'mt-3');
                    postElement.innerHTML = `
                        <div class="post-title">${post.title}</div>
                        <div class="post-content">${post.content}</div>
                    `;
                    userPosts.appendChild(postElement);
                });
            }
        }

        // Save Profile
        saveProfile.addEventListener('click', () => {
            const newUsername = profileUsername.value.trim();
            const newBloodGroup = profileBloodGroup.value;
            const newNotebook = profileNotebook.value.trim();
            if (!newUsername) {
                showNotification('Username cannot be empty!');
                return;
            }
            if (!newBloodGroup) {
                showNotification('Blood Group is required!');
                return;
            }

            const userRef = ref(db, `users/${currentUser.uid}`);
            update(userRef, {
                username: newUsername,
                bloodGroup: newBloodGroup,
                notebook: newNotebook,
                activityLog: activityLog
            })
                .then(() => {
                    profileName.textContent = newUsername;
                    showNotification('Profile updated successfully!');
                    console.log("Profile updated:", { username: newUsername, bloodGroup: newBloodGroup, notebook: newNotebook });
                })
                .catch((error) => {
                    console.error("Error updating profile:", error);
                    showNotification("Error updating profile: " + error.message);
                });
        });

        // Activity Log
        activityLogButton.addEventListener('click', () => {
            activityLogContent.innerHTML = '';
            if (activityLog.length === 0) {
                activityLogContent.innerHTML = '<p class="text-center">No activity yet.</p>';
            } else {
                activityLog.sort((a, b) => b.timestamp - a.timestamp);
                activityLog.forEach(activity => {
                    const activityItem = document.createElement('div');
                    activityItem.classList.add('activity-item');
                    const timeAgo = formatTimeAgo(activity.timestamp);
                    activityItem.innerHTML = `<span>${activity.message}</span> <span class="time-ago">${timeAgo}</span>`;
                    activityLogContent.appendChild(activityItem);
                });
            }
        });

        // Add Activity to Log
        function addActivity(message) {
            const activity = {
                message: message,
                timestamp: Date.now()
            };
            activityLog.push(activity);
            const userRef = ref(db, `users/${currentUser.uid}`);
            update(userRef, { activityLog })
                .then(() => console.log("Activity logged:", message))
                .catch((error) => console.error("Error logging activity:", error));
        }

        // Create a New Post
        submitPost.addEventListener('click', () => {
            const title = postTitle.value.trim();
            const content = postContent.value.trim();
            const type = postType.value;
            if (!title) {
                showNotification('Post title is required!');
                return;
            }
            if (!content) {
                showNotification('Please enter some content for your post!');
                return;
            }
            if (!currentUser) {
                showNotification('You must be signed in to post!');
                return;
            }

            const postsRef = ref(db, 'posts');
            const newPostRef = push(postsRef);
            const postData = {
                userId: currentUser.uid,
                username: profileUsername.value || currentUser.displayName,
                userPhoto: currentUser.photoURL || '',
                title: title,
                content: content,
                type: type,
                timestamp: Date.now(),
                reactions: { sad: 0, dislike: 0, celebrate: 0, support: 0, insightful: 0 },
                userReactions: {},
                reports: {}
            };

            set(newPostRef, postData)
                .then(() => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('postModal'));
                    modal.hide();
                    postTitle.value = '';
                    postContent.value = '';
                    addActivity(`Posted: ${title}`);
                    console.log("Post created successfully:", postData);
                })
                .catch((error) => {
                    console.error("Error creating post:", error);
                    showNotification("Error creating post: " + error.message);
                });
        });

        // Load Posts from Firebase
        function loadPosts(filterType = 'all') {
            const postsRef = ref(db, 'posts');
            onValue(postsRef, (snapshot) => {
                postsContainer.innerHTML = '';
                allPosts = [];
                snapshot.forEach((childSnapshot) => {
                    const post = childSnapshot.val();
                    post.id = childSnapshot.key;
                    allPosts.push(post);
                });

                allPosts.sort((a, b) => b.timestamp - a.timestamp);

                allPosts.forEach((post) => {
                    if (filterType === 'all' || post.type === filterType) {
                        const postElement = createPostElement(post);
                        postsContainer.appendChild(postElement);
                    }
                });
                console.log("Posts loaded:", allPosts.length);
            }, (error) => {
                console.error("Error loading posts:", error);
                postsContainer.innerHTML = '<p class="text-center">Error loading posts. Check console for details.</p>';
            });
        }

        // Load Single Post for Shared Link
        function loadSinglePost(postId) {
            const post = allPosts.find(p => p.id === postId);
            if (post) {
                postsContainer.innerHTML = '';
                const postElement = createPostElement(post);
                postsContainer.appendChild(postElement);
            } else {
                postsContainer.innerHTML = '<p class="text-center">Post not found.</p>';
                console.warn("Shared post not found:", postId);
            }
        }

        // Create Post Element
        function createPostElement(post) {
            const postDiv = document.createElement('div');
            postDiv.classList.add('post');
            postDiv.setAttribute('data-id', post.id);

            const timeAgo = formatTimeAgo(post.timestamp);
            const initial = post.username.charAt(0).toUpperCase();
            const commentCount = post.comments ? Object.keys(post.comments).length : 0;
            const isOwnPost = currentUser && post.userId === currentUser.uid;
            const userReactions = post.userReactions || {};
            const currentUserReaction = userReactions[currentUser?.uid] || '';
            const reactionCounts = post.reactions || { sad: 0, dislike: 0, celebrate: 0, support: 0, insightful: 0 };
            const reactedIcons = [];
            if (reactionCounts.sad > 0) reactedIcons.push('<span>😢</span>');
            if (reactionCounts.dislike > 0) reactedIcons.push('<span>👎</span>');
            if (reactionCounts.celebrate > 0) reactedIcons.push('<span>🎉</span>');
            if (reactionCounts.support > 0) reactedIcons.push('<span>🤝</span>');
            if (reactionCounts.insightful > 0) reactedIcons.push('<span>💡</span>');

            // Process content to detect and style links
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const formattedContent = post.content.replace(urlRegex, '<a href="$1" target="_blank">$1</a>');

            postDiv.innerHTML = `
                <div class="d-flex align-items-start position-relative">
                    <div class="user-initial">${initial}</div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <span class="username" data-user-id="${post.userId}">${post.username}</span>
                                <span class="time-ago">${timeAgo}</span>
                            </div>
                            ${isOwnPost ? `<i class="bi bi-trash delete-btn"></i>` : ''}
                        </div>
                        <div class="post-title">${post.title}</div>
                        <div class="post-content">${formattedContent}</div>
                        <div class="post-actions">
                            <span class="reaction-btn">
                                <i class="bi ${getReactionIcon(currentUserReaction)} ${currentUserReaction ? 'active-reaction' : ''}"></i>
                                <span class="reaction-icons">${reactedIcons.join(' ')}</span>
                                <span class="reaction-count">(${Object.values(reactionCounts).reduce((a, b) => a + b, 0)})</span>
                            </span>
                            <div class="reaction-menu" id="reactionMenu-${post.id}">
                                <span title="Sad" data-reaction="sad">😢</span>
                                <span title="Dislike" data-reaction="dislike">👎</span>
                                <span title="Celebrate" data-reaction="celebrate">🎉</span>
                                <span title="Support" data-reaction="support">🤝</span>
                                <span title="Insightful" data-reaction="insightful">💡</span>
                            </div>
                            <span class="comment-btn"><i class="bi bi-chat"></i> <span class="comment-count">${commentCount}</span></span>
                            <span class="report-btn"><i class="bi bi-flag"></i></span>
                            <span class="share-btn"><i class="bi bi-share"></i></span>
                            <div class="share-options" id="shareOptions-${post.id}">
                                <a href="#" data-platform="twitter">Twitter</a>
                                <a href="#" data-platform="facebook">Facebook</a>
                                <a href="#" data-platform="whatsapp">WhatsApp</a>
                                <a href="#" data-platform="copy">Copy Link</a>
                            </div>
                        </div>
                        <div class="comment-section">
                            <div class="mb-3">
                                <input type="text" class="comment-input" placeholder="Write a comment...">
                            </div>
                            <div class="comments-list"></div>
                        </div>
                    </div>
                </div>
                <div class="post-type">${post.type.charAt(0).toUpperCase() + post.type.slice(1)}</div>
            `;

            // Load comments
            if (post.comments) {
                const commentsList = postDiv.querySelector('.comments-list');
                Object.values(post.comments).forEach((comment) => {
                    const commentElement = document.createElement('div');
                    commentElement.classList.add('comment');
                    const commentTime = formatTimeAgo(comment.timestamp);
                    commentElement.innerHTML = `
                        <span class="comment-user">${comment.username}</span>
                        <span>: ${comment.content}</span>
                        <span class="comment-time">${commentTime}</span>
                    `;
                    commentsList.appendChild(commentElement);
                });
            }

            // Attach event listeners
            attachPostEventListeners(postDiv);
            return postDiv;
        }

        // Get Reaction Icon
        function getReactionIcon(reaction) {
            switch (reaction) {
                case 'sad': return 'bi-emoji-frown-fill';
                case 'dislike': return 'bi-hand-thumbs-down-fill';
                case 'celebrate': return 'bi-balloon-fill';
                case 'support': return 'bi-heart-fill';
                case 'insightful': return 'bi-lightbulb-fill';
                default: return 'bi-emoji-frown';
            }
        }

        // Attach Event Listeners to Post
        function attachPostEventListeners(post) {
            const postId = post.getAttribute('data-id');
            const postData = allPosts.find(p => p.id === postId);

            // Username click to view profile
            const username = post.querySelector('.username');
            const userId = username.getAttribute('data-user-id');
            username.addEventListener('click', () => {
                if (currentUser && userId === currentUser.uid) {
                    const profileModal = new bootstrap.Modal(document.getElementById('profileModal'));
                    profileModal.show();
                } else {
                    const userData = allUsers.find(user => user.id === userId);
                    if (userData) {
                        publicProfilePhoto.src = userData.photoURL || 'https://via.placeholder.com/100';
                        publicProfileName.textContent = userData.username;
                        publicProfileBloodGroup.textContent = `Blood Group: ${userData.bloodGroup || 'Not specified'}`;
                        publicProfileModal.show();
                    }
                }
            });

            // Reaction button with tap-and-hold
            const reactionBtn = post.querySelector('.reaction-btn');
            const reactionMenu = post.querySelector(`#reactionMenu-${postId}`);
            let holdTimeout;

            reactionBtn.addEventListener('mousedown', () => {
                holdTimeout = setTimeout(() => {
                    reactionMenu.style.display = 'flex';
                }, 500);
            });

            reactionBtn.addEventListener('mouseup', () => {
                clearTimeout(holdTimeout);
                if (reactionMenu.style.display !== 'flex') {
                    if (!currentUser) {
                        showNotification('Please sign in to react to posts!');
                        return;
                    }
                    toggleReaction(postId, postData, 'sad', reactionBtn);
                }
            });

            reactionBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                holdTimeout = setTimeout(() => {
                    reactionMenu.style.display = 'flex';
                }, 500);
            });

            reactionBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                clearTimeout(holdTimeout);
                if (reactionMenu.style.display !== 'flex') {
                    if (!currentUser) {
                        showNotification('Please sign in to react to posts!');
                        return;
                    }
                    toggleReaction(postId, postData, 'sad', reactionBtn);
                }
            });

            reactionMenu.querySelectorAll('span').forEach(option => {
                option.addEventListener('click', () => {
                    const reaction = option.getAttribute('data-reaction');
                    if (!currentUser) {
                        showNotification('Please sign in to react to posts!');
                        return;
                    }
                    toggleReaction(postId, postData, reaction, reactionBtn);
                    reactionMenu.style.display = 'none';
                });
            });

            // Show who reacted
            const reactionCount = post.querySelector('.reaction-count');
            reactionCount.addEventListener('click', async () => {
                const userReactions = postData.userReactions || {};
                reactionDetails.innerHTML = '';
                for (const [uid, reaction] of Object.entries(userReactions)) {
                    const userRef = ref(db, `users/${uid}`);
                    const userSnapshot = await get(userRef);
                    const userData = userSnapshot.val();
                    if (userData) {
                        const reactionItem = document.createElement('div');
                        reactionItem.classList.add('reaction-item');
                        reactionItem.innerHTML = `
                            <span>${userData.username}</span>
                            <span>${getReactionEmoji(reaction)}</span>
                        `;
                        reactionDetails.appendChild(reactionItem);
                    }
                }
                if (!reactionDetails.innerHTML) {
                    reactionDetails.innerHTML = '<p class="text-center">No reactions yet.</p>';
                }
                reactionModal.show();
            });

            // Hide reaction menu when clicking outside
            document.addEventListener('click', (e) => {
                if (!reactionBtn.contains(e.target) && !reactionMenu.contains(e.target)) {
                    reactionMenu.style.display = 'none';
                }
            });

            // Comment button
            const commentBtn = post.querySelector('.comment-btn');
            commentBtn.addEventListener('click', () => {
                const commentSection = post.querySelector('.comment-section');
                commentSection.classList.toggle('active');
                if (commentSection.classList.contains('active')) {
                    commentSection.querySelector('.comment-input').focus();
                }
            });

            // Comment input
            const commentInput = post.querySelector('.comment-input');
            commentInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && commentInput.value.trim()) {
                    if (!currentUser) {
                        showNotification('Please sign in to comment!');
                        return;
                    }
                    const commentsRef = ref(db, `posts/${postId}/comments`);
                    const newCommentRef = push(commentsRef);
                    const commentData = {
                        username: profileUsername.value || currentUser.displayName,
                        content: commentInput.value.trim(),
                        timestamp: Date.now()
                    };

                    set(newCommentRef, commentData)
                        .then(() => {
                            commentInput.value = '';
                            addActivity(`Commented on: ${postData.title}`);
                            console.log("Comment added:", commentData);
                        })
                        .catch((error) => {
                            console.error("Error adding comment:", error);
                            showNotification("Error adding comment: " + error.message);
                        });
                }
            });

            // Report button
            const reportBtn = post.querySelector('.report-btn');
            reportBtn.addEventListener('click', () => {
                if (!currentUser) {
                    showNotification('Please sign in to report posts!');
                    return;
                }
                currentPostId = postId;
                reportReason.value = '';
                reportList.innerHTML = '';
                const reports = postData.reports || {};
                Object.values(reports).forEach(report => {
                    const reportItem = document.createElement('div');
                    reportItem.classList.add('report-item');
                    const reportTime = formatTimeAgo(report.timestamp);
                    reportItem.innerHTML = `
                        <span>${report.username}: ${report.reason}</span>
                        <span class="time-ago">${reportTime}</span>
                    `;
                    reportList.appendChild(reportItem);
                });
                if (!reportList.innerHTML) {
                    reportList.innerHTML = '<p class="text-center">No reports yet.</p>';
                }
                reportModal.show();
            });

            // Submit report
            submitReport.addEventListener('click', () => {
                const reason = reportReason.value.trim();
                if (!reason) {
                    showNotification('Please provide a reason for reporting!');
                    return;
                }
                const reportsRef = ref(db, `posts/${currentPostId}/reports`);
                const newReportRef = push(reportsRef);
                const reportData = {
                    username: profileUsername.value || currentUser.displayName,
                    reason: reason,
                    timestamp: Date.now()
                };
                set(newReportRef, reportData)
                    .then(() => {
                        reportModal.hide();
                        addActivity(`Reported post: ${postData.title}`);
                        console.log("Report submitted:", reportData);
                    })
                    .catch((error) => {
                        console.error("Error submitting report:", error);
                        showNotification("Error submitting report: " + error.message);
                    });
            });

            // Share button
            const shareBtn = post.querySelector('.share-btn');
            const shareOptions = post.querySelector(`#shareOptions-${postId}`);
            shareBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const shareUrl = `${window.location.origin}${window.location.pathname}?post=${postId}`;
                const shareText = `${postData.title}\n${postData.content}\nCheck it out: ${shareUrl}`;

                if (navigator.share) {
                    navigator.share({
                        title: postData.title,
                        text: postData.content,
                        url: shareUrl
                    }).then(() => {
                        console.log("Shared successfully via native share");
                    }).catch((error) => {
                        console.error("Error sharing via native share:", error);
                        showShareOptions();
                    });
                } else {
                    showShareOptions();
                }

                function showShareOptions() {
                    shareOptions.style.display = shareOptions.style.display === 'block' ? 'none' : 'block';
                    shareOptions.style.left = `${shareBtn.offsetLeft}px`;
                    shareOptions.style.top = `${shareBtn.offsetTop + shareBtn.offsetHeight + 5}px`;

                    shareOptions.querySelectorAll('a').forEach(link => {
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const platform = e.target.getAttribute('data-platform');
                            let url = '';
                            switch (platform) {
                                case 'twitter':
                                    url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}`;
                                    break;
                                case 'facebook':
                                    url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`;
                                    break;
                                case 'whatsapp':
                                    url = `https://api.whatsapp.com/send?text=${encodeURIComponent(shareText)}`;
                                    break;
                                case 'copy':
                                    navigator.clipboard.writeText(shareUrl);
                                    showNotification('Link copied to clipboard!');
                                    shareOptions.style.display = 'none';
                                    return;
                            }
                            window.open(url, '_blank');
                            shareOptions.style.display = 'none';
                        });
                    });
                }
            });

            // Hide share options when clicking outside
            document.addEventListener('click', (e) => {
                if (!shareBtn.contains(e.target) && !shareOptions.contains(e.target)) {
                    shareOptions.style.display = 'none';
                }
            });

            // Delete button
            const deleteBtn = post.querySelector('.delete-btn');
            if (deleteBtn) {
                const deleteModal = new bootstrap.Modal(document.getElementById('notificationModal'));
                deleteBtn.addEventListener('click', () => {
                    notificationMessage.innerHTML = 'Are you sure you want to delete this post?';
                    notificationModal.show();

                    const okButton = document.querySelector('#notificationModal .btn-primary');
                    const handler = () => {
                        const postRef = ref(db, `posts/${postId}`);
                        remove(postRef)
                            .then(() => {
                                addActivity(`Deleted post: ${postData.title}`);
                                console.log("Post deleted:", postId);
                            })
                            .catch((error) => console.error("Error deleting post:", error));
                        notificationModal.hide();
                        okButton.removeEventListener('click', handler);
                    };
                    okButton.addEventListener('click', handler);
                });
            }
        }

        // Toggle Reaction
        function toggleReaction(postId, postData, reaction, reactionBtn) {
            const reactions = postData.reactions || { sad: 0, dislike: 0, celebrate: 0, support: 0, insightful: 0 };
            const userReactions = postData.userReactions || {};
            const currentUserReaction = userReactions[currentUser.uid];

            if (currentUserReaction) {
                reactions[currentUserReaction]--;
            }
            if (currentUserReaction !== reaction) {
                reactions[reaction]++;
                userReactions[currentUser.uid] = reaction;
            } else {
                delete userReactions[currentUser.uid];
            }

            const postRef = ref(db, `posts/${postId}`);
            update(postRef, { reactions, userReactions })
                .then(() => {
                    const icon = reactionBtn.querySelector('i');
                    icon.className = `bi ${getReactionIcon(userReactions[currentUser.uid])}`;
                    if (userReactions[currentUser.uid]) {
                        icon.classList.add('active-reaction');
                    } else {
                        icon.classList.remove('active-reaction');
                    }
                    const reactedIcons = [];
                    if (reactions.sad > 0) reactedIcons.push('<span>😢</span>');
                    if (reactions.dislike > 0) reactedIcons.push('<span>👎</span>');
                    if (reactions.celebrate > 0) reactedIcons.push('<span>🎉</span>');
                    if (reactions.support > 0) reactedIcons.push('<span>🤝</span>');
                    if (reactions.insightful > 0) reactedIcons.push('<span>💡</span>');
                    reactionBtn.querySelector('.reaction-icons').innerHTML = reactedIcons.join(' ');
                    reactionBtn.querySelector('.reaction-count').textContent = `(${Object.values(reactions).reduce((a, b) => a + b, 0)})`;
                    addActivity(`Reacted "${reaction}" to: ${postData.title}`);
                    console.log("Reaction updated:", reactions);
                })
                .catch((error) => console.error("Error updating reaction:", error));
        }

        // Get Reaction Emoji
        function getReactionEmoji(reaction) {
            switch (reaction) {
                case 'sad': return '😢';
                case 'dislike': return '👎';
                case 'celebrate': return '🎉';
                case 'support': return '🤝';
                case 'insightful': return '💡';
                default: return '';
            }
        }

        // Format Time Ago
        function formatTimeAgo(timestamp) {
            const now = Date.now();
            const seconds = Math.floor((now - timestamp) / 1000);
            if (seconds < 60) return `${seconds}s ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }

        // Tab Filtering
        document.querySelectorAll('.nav-link').forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.nav-link').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                const filterType = tab.getAttribute('data-tab');
                loadPosts(filterType);
            });
        });

        // Advanced Search Functionality
        searchInput.addEventListener('input', () => {
            const queryText = searchInput.value.trim().toLowerCase();
            searchResults.innerHTML = '';
            searchResults.style.display = queryText ? 'block' : 'none';

            if (!queryText) return;

            // Detect blood group search
            const bloodGroups = ['a+', 'a-', 'b+', 'b-', 'ab+', 'ab-', 'o+', 'o-'];
            const isBloodGroupSearch = bloodGroups.includes(queryText);

            if (isBloodGroupSearch) {
                const matchingUsers = allUsers.filter(user => user.bloodGroup && user.bloodGroup.toLowerCase() === queryText);
                if (matchingUsers.length > 0) {
                    const header = document.createElement('div');
                    header.classList.add('search-result-item');
                    header.innerHTML = '<span>Users with Blood Group</span>';
                    searchResults.appendChild(header);

                    matchingUsers.forEach(user => {
                        const resultItem = document.createElement('div');
                        resultItem.classList.add('search-result-item');
                        resultItem.innerHTML = `${user.username} (${user.bloodGroup})`;
                        resultItem.addEventListener('click', () => {
                            postsContainer.innerHTML = '';
                            const userPosts = allPosts.filter(post => post.userId === user.id);
                            userPosts.forEach(post => {
                                const postElement = createPostElement(post);
                                postsContainer.appendChild(postElement);
                            });
                            searchResults.style.display = 'none';
                            searchInput.value = '';
                        });
                        searchResults.appendChild(resultItem);
                    });
                }
            }

            // Search users
            const matchingUsers = allUsers.filter(user => user.username.toLowerCase().includes(queryText));
            if (matchingUsers.length > 0 && !isBloodGroupSearch) {
                const header = document.createElement('div');
                header.classList.add('search-result-item');
                header.innerHTML = '<span>Users</span>';
                searchResults.appendChild(header);

                matchingUsers.forEach(user => {
                    const resultItem = document.createElement('div');
                    resultItem.classList.add('search-result-item');
                    resultItem.innerHTML = `${user.username}`;
                    resultItem.addEventListener('click', () => {
                        postsContainer.innerHTML = '';
                        const userPosts = allPosts.filter(post => post.userId === user.id);
                        userPosts.forEach(post => {
                            const postElement = createPostElement(post);
                            postsContainer.appendChild(postElement);
                        });
                        searchResults.style.display = 'none';
                        searchInput.value = '';
                    });
                    searchResults.appendChild(resultItem);
                });
            }

            // Search posts by title and content
            const matchingPosts = allPosts.filter(post =>
                post.title.toLowerCase().includes(queryText) ||
                post.content.toLowerCase().includes(queryText)
            ).sort((a, b) => {
                const aTitleMatch = a.title.toLowerCase().includes(queryText) ? 1 : 0;
                const bTitleMatch = b.title.toLowerCase().includes(queryText) ? 1 : 0;
                const aContentMatch = a.content.toLowerCase().includes(queryText) ? 1 : 0;
                const bContentMatch = b.content.toLowerCase().includes(queryText) ? 1 : 0;

                // Prioritize title matches over content matches
                if (aTitleMatch !== bTitleMatch) return bTitleMatch - aTitleMatch;
                if (aContentMatch !== bContentMatch) return bContentMatch - aContentMatch;
                return b.timestamp - a.timestamp; // Sort by recency if matches are equal
            });

            if (matchingPosts.length > 0) {
                const header = document.createElement('div');
                header.classList.add('search-result-item');
                header.innerHTML = '<span>Posts</span>';
                searchResults.appendChild(header);

                matchingPosts.forEach(post => {
                    const resultItem = document.createElement('div');
                    resultItem.classList.add('search-result-item');
                    const matchSource = post.title.toLowerCase().includes(queryText) ? 'Title' : 'Content';
                    resultItem.innerHTML = `${matchSource}: ${post.title.substring(0, 30)}... (by ${post.username})`;
                    resultItem.addEventListener('click', () => {
                        postsContainer.innerHTML = '';
                        const postElement = createPostElement(post);
                        postsContainer.appendChild(postElement);
                        searchResults.style.display = 'none';
                        searchInput.value = '';
                    });
                    searchResults.appendChild(resultItem);
                });
            }

            if (searchResults.children.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item">No results found</div>';
            }
        });

        // Hide search results when clicking outside
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });

        // Check for shared post in URL
        function checkSharedPost() {
            const urlParams = new URLSearchParams(window.location.search);
            const postId = urlParams.get('post');
            if (postId) {
                const postsRef = ref(db, 'posts');
                onValue(postsRef, (snapshot) => {
                    allPosts = [];
                    snapshot.forEach((childSnapshot) => {
                        const post = childSnapshot.val();
                        post.id = childSnapshot.key;
                        allPosts.push(post);
                    });
                    loadSinglePost(postId);
                }, { onlyOnce: true }, (error) => {
                    console.error("Error loading shared post:", error);
                    postsContainer.innerHTML = '<p class="text-center">Error loading post.</p>';
                });
            } else {
                loadPosts();
            }
        }

        // Show Notification Modal
        function showNotification(message) {
            notificationMessage.textContent = message;
            notificationModal.show();
        }
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>